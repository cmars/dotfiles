#!/bin/bash
#
# Copyright Â© 2014 Casey Marshall <github@cmarstech.com>
# This work is free. You can redistribute it and/or modify it under the
# terms of the Do What The Fuck You Want To Public License, Version 2,
# as published by Sam Hocevar. See the COPYING file for more details.
#
# gowork launches tmux with an environment suited to the particular developer
# hat I'm wearing.

WORKSPACE="$1"
PROJECT="$2"

if [ -z "${WORKSPACE}" ]; then
	echo "Usage: $0 <workspace> [<project>]"
	exit 1
fi

session_digest=( $(echo ${WORKSPACE}-${PROJECT} | md5sum) )
SESSION=${USER}-${session_digest[0]}
echo ${SESSION}

GOPATH=${HOME}/${WORKSPACE}/gocode
if [ ! -d "${GOPATH}" ]; then
	echo "${GOPATH} not found"
	exit 1
fi

case "${WORKSPACE}" in
	cmarstech)
		DEBEMAIL=cmars@cmarstech.com
		DEBFULLNAME='Casey Marshall'
		;;
	canonical)
		DEBEMAIL=casey.marshall@canonical.com
		DEBFULLNAME='Casey Marshall'
		;;
esac

cd ${GOPATH}/src

tmux update-environment

if [ -n "${PROJECT}" ]; then
	# Choose the shortest matching path
	PROJECTPATH=$( \
		for p in $(find ${GOPATH} -path "${GOPATH}/src/*${PROJECT}"); do \
			echo $(echo $p | wc -c) $p; \
		done | sort -n -k1 | awk '{print $2}' | head -1 )

	if [ ! -d "${PROJECTPATH}" ]; then
		echo "Project ${PROJECT} not found"
		exit 1
	fi
	cd ${PROJECTPATH}
	if tmux -2 new-session -d -s ${SESSION}; then
		tmux set-environment -t ${SESSION} GOPATH ${GOPATH}
		tmux send-keys 'vim' C-m
		tmux send-keys '\n'
		tmux new-window -t ${SESSION}:1 -n 'shell'
		tmux select-window -t ${SESSION}:0
	fi
else 
	if tmux -2 new-session -d -s ${SESSION}; then
		tmux set-environment -t ${SESSION} GOPATH ${GOPATH}
	fi
fi

tmux attach -t ${SESSION}
